"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const os = require("os");
const path = require("path");
const fs = require("fs-extra");
const diskusage = require("diskusage");
class NodeDiskCache {
    constructor(options = {}) {
        //缓存数据索引列表。name:文件名,size:文件大小,timer:过期计时器
        this._cacheTable = new Map();
        //当前缓存大小
        this._currentSize = 0;
        //文件名称自增索引
        this._fileNameIndex = 0;
        //缓存目录
        this._cacheDir = options.cacheDir || path.join(os.tmpdir(), `NodeDiskCache_${Math.trunc(Math.random() * 10000)}`);
        if (NodeDiskCache._cacheDirList.has(this._cacheDir))
            throw new Error(`缓存目录已被占用：'${this._cacheDir}'`);
        fs.emptyDirSync(this._cacheDir);
        NodeDiskCache._cacheDirList.add(this._cacheDir);
        //清理缓存
        if (options.volumeUpLimit > 0) {
            const upLimit = options.volumeUpLimit;
            this._cleanerTimer = setInterval(() => {
                if (this._currentSize > upLimit)
                    this._cleanCache(upLimit * 0.9);
            }, 5000);
        }
        else if (options.volumeUpLimitRate > 0) {
            const upLimitRate = Math.min(options.volumeUpLimitRate, 1);
            const downLimitRate = 1 - upLimitRate;
            this._cleanerTimer = setInterval(async () => {
                try {
                    const usage = await diskusage.check(this._cacheDir);
                    if (usage.available / usage.total < downLimitRate)
                        this._cleanCache(this._currentSize - usage.total * upLimitRate * 0.1);
                }
                catch (err) {
                    console.error('获取缓存目录容量信息异常：', err);
                }
            }, 5000);
        }
        //缓存超时
        this._timeout = options.timeout > 0 ? options.timeout : 0;
        this._refreshTimeoutWhenGet = !!options.refreshTimeoutWhenGet;
    }
    /**
     * 获取当前的缓存大小
     */
    get size() { return this._currentSize; }
    /**
     * 清理缓存
     * @param downTo 将缓存大小下降到指定数值之下
     */
    async _cleanCache(downTo) {
        try {
            for (const [key, value] of this._cacheTable) {
                if (this._currentSize > downTo) {
                    this._cacheTable.delete(key);
                    clearTimeout(value.timer);
                    await fs.remove(value.name);
                    this._currentSize -= value.size;
                }
                else
                    break;
            }
        }
        catch (err) {
            console.error('清除缓存异常：', err);
        }
    }
    /**
     * 在执行set之前做的一些准备工作
     * @param writer 执行文件读取操作的方法
     */
    async _prepareSet(key, writer) {
        let cache = this._cacheTable.get(key);
        if (cache) {
            if (this._timeout > 0)
                clearTimeout(cache.timer); //清理旧的计时器
            try {
                //执行存储方法
                await writer(cache.name);
                //查询文件大小
                const status = await fs.promises.stat(cache.name);
                this._currentSize -= cache.size;
                cache.size = status.blksize || status.size;
                this._currentSize += cache.size;
            }
            finally {
                //设置计时器
                if (this._timeout > 0) {
                    cache.timer = setTimeout(() => {
                        this._cacheTable.delete(key);
                        fs.remove(cache.name, err => {
                            if (err)
                                console.error('清除缓存异常：', err);
                            else
                                this._currentSize -= cache.size;
                        });
                    }, this._timeout);
                }
            }
            this._cacheTable.delete(key); //刷新缓存在列表中的排位
            this._cacheTable.set(key, cache);
        }
        else {
            cache = { name: path.join(this._cacheDir, (this._fileNameIndex++).toString()), size: 0, timer: undefined };
            //执行存储方法
            await writer(cache.name);
            //查询文件大小
            const status = await fs.promises.stat(cache.name);
            cache.size = status.blksize || status.size;
            this._currentSize += cache.size;
            //设置计时器
            if (this._timeout > 0) {
                cache.timer = setTimeout(() => {
                    this._cacheTable.delete(key);
                    fs.remove(cache.name, err => {
                        if (err)
                            console.error('清除缓存异常：', err);
                        else
                            this._currentSize -= cache.size;
                    });
                }, this._timeout);
            }
            this._cacheTable.set(key, cache);
        }
    }
    /**
     * 在执行get之前做的一些准备工作
     * @param reader 执行文件读取操作的方法
     */
    async _prepareGet(key, reader) {
        const cache = this._cacheTable.get(key);
        if (cache) {
            if (this._refreshTimeoutWhenGet && this._timeout > 0) {
                this._cacheTable.delete(key); //刷新缓存在列表中的排位
                this._cacheTable.set(key, cache);
                cache.timer.refresh();
            }
            return reader(cache.name);
        }
        else
            return cache;
    }
    /**
     * 设置或更新缓存
     * @param isAppend 是否以追加到文件末尾的方式写入数据，默认false
     */
    set(key, value, isAppend = false) {
        return this._prepareSet(key, path => {
            if ('string' === typeof value || Buffer.isBuffer(value))
                return fs.promises.writeFile(path, value, { flag: isAppend ? 'a' : 'w' });
            else {
                return new Promise((resolve, reject) => {
                    value.pipe(fs.createWriteStream(path, { flags: isAppend ? 'a' : 'w' }))
                        .on('error', reject)
                        .on('close', resolve);
                });
            }
        });
    }
    /**
     * 通过移动现存文件的方式设置或更新缓存
     * @param from 要移动文件的路径
     */
    setByMove(key, from) {
        return this._prepareSet(key, path => fs.move(from, path));
    }
    /**
     * 获取缓存
     */
    get(key) {
        return this._prepareGet(key, fs.readFile);
    }
    /**
     * 以流的方式获取缓存
     */
    getStream(key) {
        return this._prepareGet(key, async (path) => fs.createReadStream(path));
    }
    /**
     * 判断缓存是否存在
     */
    has(key) {
        return this._cacheTable.has(key);
    }
    /**
     * 删除缓存
     */
    async delete(key) {
        const cache = this._cacheTable.get(key);
        if (cache) {
            await fs.remove(cache.name);
            this._cacheTable.delete(key);
            clearTimeout(cache.timer);
            this._currentSize -= cache.size;
        }
    }
    /**
     * 清空缓存
     */
    async empty() {
        for (const [key, value] of this._cacheTable) {
            await fs.remove(value.name);
            this._cacheTable.delete(key);
            clearTimeout(value.timer);
            this._currentSize -= value.size;
        }
    }
    /**
     * 销毁缓存
     */
    async destroy() {
        await this.empty();
        clearInterval(this._cleanerTimer);
    }
}
//缓存目录列表，防止某一缓存目录被重复使用
NodeDiskCache._cacheDirList = new Set();
exports.default = NodeDiskCache;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUFJLENBQUMsV0FBVyxFQUFFO1lBQ3pDLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDNUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDN0IsWUFBWSxDQUFDLEtBQUssQ0FBQyxLQUFZLENBQUMsQ0FBQztZQUNqQyxJQUFJLENBQUMsWUFBWSxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUM7U0FDbkM7SUFDTCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsT0FBTztRQUNULE1BQU0sSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ25CLGFBQWEsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDdEMsQ0FBQzs7QUEvT0Qsc0JBQXNCO0FBQ0UsMkJBQWEsR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO0FBVDlELGdDQXdQQyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIG9zIGZyb20gJ29zJztcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcclxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xyXG5pbXBvcnQgKiBhcyBkaXNrdXNhZ2UgZnJvbSAnZGlza3VzYWdlJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgTm9kZURpc2tDYWNoZU9wdGlvbnMge1xyXG4gICAgLyoqXHJcbiAgICAgKiDnvJPlrZjnm67lvZXlnLDlnYDvvIzpu5jorqQnL3RtcC9Ob2RlRGlza0NhY2hlX3tyYW5kb219J1xyXG4gICAgICovXHJcbiAgICBjYWNoZURpcj86IHN0cmluZztcclxuXHJcbiAgICAvKipcclxuICAgICAqIOe8k+WtmOWuuemHj+S4iumZkChieXRlKe+8jOm7mOiupOS4ujDvvIzmsqHmnInkuIrpmZBcclxuICAgICAqL1xyXG4gICAgdm9sdW1lVXBMaW1pdD86IG51bWJlcjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOWKqOaAgeebkea1i+e8k+WtmOebruW9leWJqeS9meWuuemHj++8jOW9k+W3sueUqOWuuemHj+WNoOaAu+WuuemHj+i2hei/h+aMh+WumuavlOS+i+WQjuaJp+ihjOa4heeQhuaTjeS9nOOAguiMg+WbtDAtMe+8jOm7mOiupDDvvIzmsqHmnInkuIrpmZDjgILlpoLmnpzorr7nva7kuoZ2b2x1bWVVcExpbWl05YiZ5Lya5L2/6K+l5bGe5oCn5aSx5pWIXHJcbiAgICAgKi9cclxuICAgIHZvbHVtZVVwTGltaXRSYXRlPzogbnVtYmVyO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICog6K6+572u57yT5a2Y6L+H5pyf5pe26Ze0KG1zKe+8jDDkuLrmsLjkuI3ov4fmnJ/jgILpu5jorqQwXHJcbiAgICAgKi9cclxuICAgIHRpbWVvdXQ/OiBudW1iZXI7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlvZPojrflj5bnvJPlrZjml7bmmK/lkKbph43nva50aW1lb3V077yM6buY6K6kZmFsc2VcclxuICAgICAqL1xyXG4gICAgcmVmcmVzaFRpbWVvdXRXaGVuR2V0PzogYm9vbGVhbjtcclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTm9kZURpc2tDYWNoZSB7XHJcblxyXG4gICAgLy/nvJPlrZjmlbDmja7ntKLlvJXliJfooajjgIJuYW1lOuaWh+S7tuWQjSxzaXplOuaWh+S7tuWkp+Wwjyx0aW1lcjrov4fmnJ/orqHml7blmahcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgX2NhY2hlVGFibGUgPSBuZXcgTWFwPHN0cmluZywgeyBuYW1lOiBzdHJpbmcsIHNpemU6IG51bWJlciwgdGltZXI6IE5vZGVKUy5UaW1lciB8IHVuZGVmaW5lZCB9PigpO1xyXG5cclxuICAgIC8v57yT5a2Y5pWw5o2u5a2Y5pS+55uu5b2VXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9jYWNoZURpcjogc3RyaW5nO1xyXG5cclxuICAgIC8v57yT5a2Y55uu5b2V5YiX6KGo77yM6Ziy5q2i5p+Q5LiA57yT5a2Y55uu5b2V6KKr6YeN5aSN5L2/55SoXHJcbiAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBfY2FjaGVEaXJMaXN0ID0gbmV3IFNldDxzdHJpbmc+KCk7XHJcblxyXG4gICAgLy/nvJPlrZjotoXml7ZcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgX3RpbWVvdXQ6IG51bWJlcjtcclxuXHJcbiAgICAvL+aYr+WQpuiOt+WPlue8k+WtmOaXtumHjee9rnRpbWVvdXRcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgX3JlZnJlc2hUaW1lb3V0V2hlbkdldDogYm9vbGVhbjtcclxuXHJcbiAgICAvL+a4heeQhue8k+WtmOiuoeaXtuWZqFxyXG4gICAgcHJpdmF0ZSByZWFkb25seSBfY2xlYW5lclRpbWVyOiBOb2RlSlMuVGltZXI7XHJcblxyXG4gICAgLy/lvZPliY3nvJPlrZjlpKflsI9cclxuICAgIHByaXZhdGUgX2N1cnJlbnRTaXplID0gMDtcclxuXHJcbiAgICAvL+aWh+S7tuWQjeensOiHquWinue0ouW8lVxyXG4gICAgcHJpdmF0ZSBfZmlsZU5hbWVJbmRleCA9IDA7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDojrflj5blvZPliY3nmoTnvJPlrZjlpKflsI9cclxuICAgICAqL1xyXG4gICAgZ2V0IHNpemUoKSB7IHJldHVybiB0aGlzLl9jdXJyZW50U2l6ZTsgfVxyXG5cclxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IE5vZGVEaXNrQ2FjaGVPcHRpb25zID0ge30pIHtcclxuICAgICAgICAvL+e8k+WtmOebruW9lVxyXG4gICAgICAgIHRoaXMuX2NhY2hlRGlyID0gb3B0aW9ucy5jYWNoZURpciB8fCBwYXRoLmpvaW4ob3MudG1wZGlyKCksIGBOb2RlRGlza0NhY2hlXyR7TWF0aC50cnVuYyhNYXRoLnJhbmRvbSgpICogMTAwMDApfWApO1xyXG4gICAgICAgIGlmIChOb2RlRGlza0NhY2hlLl9jYWNoZURpckxpc3QuaGFzKHRoaXMuX2NhY2hlRGlyKSlcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGDnvJPlrZjnm67lvZXlt7LooqvljaDnlKjvvJonJHt0aGlzLl9jYWNoZURpcn0nYCk7XHJcbiAgICAgICAgZnMuZW1wdHlEaXJTeW5jKHRoaXMuX2NhY2hlRGlyKTtcclxuICAgICAgICBOb2RlRGlza0NhY2hlLl9jYWNoZURpckxpc3QuYWRkKHRoaXMuX2NhY2hlRGlyKTtcclxuXHJcbiAgICAgICAgLy/muIXnkIbnvJPlrZhcclxuICAgICAgICBpZiAob3B0aW9ucy52b2x1bWVVcExpbWl0IGFzIG51bWJlciA+IDApIHtcclxuICAgICAgICAgICAgY29uc3QgdXBMaW1pdCA9IG9wdGlvbnMudm9sdW1lVXBMaW1pdCBhcyBudW1iZXI7XHJcbiAgICAgICAgICAgIHRoaXMuX2NsZWFuZXJUaW1lciA9IHNldEludGVydmFsKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLl9jdXJyZW50U2l6ZSA+IHVwTGltaXQpXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2xlYW5DYWNoZSh1cExpbWl0ICogMC45KTtcclxuICAgICAgICAgICAgfSwgNTAwMCk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zLnZvbHVtZVVwTGltaXRSYXRlIGFzIG51bWJlciA+IDApIHtcclxuICAgICAgICAgICAgY29uc3QgdXBMaW1pdFJhdGUgPSBNYXRoLm1pbihvcHRpb25zLnZvbHVtZVVwTGltaXRSYXRlIGFzIG51bWJlciwgMSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGRvd25MaW1pdFJhdGUgPSAxIC0gdXBMaW1pdFJhdGU7XHJcbiAgICAgICAgICAgIHRoaXMuX2NsZWFuZXJUaW1lciA9IHNldEludGVydmFsKGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXNhZ2UgPSBhd2FpdCBkaXNrdXNhZ2UuY2hlY2sodGhpcy5fY2FjaGVEaXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh1c2FnZS5hdmFpbGFibGUgLyB1c2FnZS50b3RhbCA8IGRvd25MaW1pdFJhdGUpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2NsZWFuQ2FjaGUodGhpcy5fY3VycmVudFNpemUgLSB1c2FnZS50b3RhbCAqIHVwTGltaXRSYXRlICogMC4xKTtcclxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ+iOt+WPlue8k+WtmOebruW9leWuuemHj+S/oeaBr+W8guW4uO+8micsIGVycik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sIDUwMDApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy/nvJPlrZjotoXml7ZcclxuICAgICAgICB0aGlzLl90aW1lb3V0ID0gb3B0aW9ucy50aW1lb3V0IGFzIG51bWJlciA+IDAgPyBvcHRpb25zLnRpbWVvdXQgYXMgbnVtYmVyIDogMDtcclxuICAgICAgICB0aGlzLl9yZWZyZXNoVGltZW91dFdoZW5HZXQgPSAhIW9wdGlvbnMucmVmcmVzaFRpbWVvdXRXaGVuR2V0O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5riF55CG57yT5a2YXHJcbiAgICAgKiBAcGFyYW0gZG93blRvIOWwhue8k+WtmOWkp+Wwj+S4i+mZjeWIsOaMh+WumuaVsOWAvOS5i+S4i1xyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGFzeW5jIF9jbGVhbkNhY2hlKGRvd25UbzogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgdGhpcy5fY2FjaGVUYWJsZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX2N1cnJlbnRTaXplID4gZG93blRvKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2FjaGVUYWJsZS5kZWxldGUoa2V5KTtcclxuICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodmFsdWUudGltZXIgYXMgYW55KTtcclxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBmcy5yZW1vdmUodmFsdWUubmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudFNpemUgLT0gdmFsdWUuc2l6ZTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ+a4hemZpOe8k+WtmOW8guW4uO+8micsIGVycik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Zyo5omn6KGMc2V05LmL5YmN5YGa55qE5LiA5Lqb5YeG5aSH5bel5L2cXHJcbiAgICAgKiBAcGFyYW0gd3JpdGVyIOaJp+ihjOaWh+S7tuivu+WPluaTjeS9nOeahOaWueazlVxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGFzeW5jIF9wcmVwYXJlU2V0KGtleTogc3RyaW5nLCB3cml0ZXI6IChwYXRoOiBzdHJpbmcpID0+IFByb21pc2U8dm9pZD4pOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBsZXQgY2FjaGUgPSB0aGlzLl9jYWNoZVRhYmxlLmdldChrZXkpO1xyXG5cclxuICAgICAgICBpZiAoY2FjaGUpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuX3RpbWVvdXQgPiAwKSBjbGVhclRpbWVvdXQoY2FjaGUudGltZXIgYXMgYW55KTsgLy/muIXnkIbml6fnmoTorqHml7blmahcclxuXHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICAvL+aJp+ihjOWtmOWCqOaWueazlVxyXG4gICAgICAgICAgICAgICAgYXdhaXQgd3JpdGVyKGNhY2hlLm5hbWUpO1xyXG5cclxuICAgICAgICAgICAgICAgIC8v5p+l6K+i5paH5Lu25aSn5bCPXHJcbiAgICAgICAgICAgICAgICBjb25zdCBzdGF0dXMgPSBhd2FpdCBmcy5wcm9taXNlcy5zdGF0KGNhY2hlLm5hbWUpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudFNpemUgLT0gY2FjaGUuc2l6ZTtcclxuICAgICAgICAgICAgICAgIGNhY2hlLnNpemUgPSBzdGF0dXMuYmxrc2l6ZSB8fCBzdGF0dXMuc2l6ZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2N1cnJlbnRTaXplICs9IGNhY2hlLnNpemU7XHJcbiAgICAgICAgICAgIH0gZmluYWxseSB7XHJcbiAgICAgICAgICAgICAgICAvL+iuvue9ruiuoeaXtuWZqFxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuX3RpbWVvdXQgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FjaGUudGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY2FjaGVUYWJsZS5kZWxldGUoa2V5KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZnMucmVtb3ZlKChjYWNoZSBhcyBhbnkpLm5hbWUsIGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ+a4hemZpOe8k+WtmOW8guW4uO+8micsIGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudFNpemUgLT0gKGNhY2hlIGFzIGFueSkuc2l6ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcy5fdGltZW91dCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRoaXMuX2NhY2hlVGFibGUuZGVsZXRlKGtleSk7ICAgLy/liLfmlrDnvJPlrZjlnKjliJfooajkuK3nmoTmjpLkvY1cclxuICAgICAgICAgICAgdGhpcy5fY2FjaGVUYWJsZS5zZXQoa2V5LCBjYWNoZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY2FjaGUgPSB7IG5hbWU6IHBhdGguam9pbih0aGlzLl9jYWNoZURpciwgKHRoaXMuX2ZpbGVOYW1lSW5kZXgrKykudG9TdHJpbmcoKSksIHNpemU6IDAsIHRpbWVyOiB1bmRlZmluZWQgfTtcclxuXHJcbiAgICAgICAgICAgIC8v5omn6KGM5a2Y5YKo5pa55rOVXHJcbiAgICAgICAgICAgIGF3YWl0IHdyaXRlcihjYWNoZS5uYW1lKTtcclxuXHJcbiAgICAgICAgICAgIC8v5p+l6K+i5paH5Lu25aSn5bCPXHJcbiAgICAgICAgICAgIGNvbnN0IHN0YXR1cyA9IGF3YWl0IGZzLnByb21pc2VzLnN0YXQoY2FjaGUubmFtZSk7XHJcbiAgICAgICAgICAgIGNhY2hlLnNpemUgPSBzdGF0dXMuYmxrc2l6ZSB8fCBzdGF0dXMuc2l6ZTtcclxuICAgICAgICAgICAgdGhpcy5fY3VycmVudFNpemUgKz0gY2FjaGUuc2l6ZTtcclxuXHJcbiAgICAgICAgICAgIC8v6K6+572u6K6h5pe25ZmoXHJcbiAgICAgICAgICAgIGlmICh0aGlzLl90aW1lb3V0ID4gMCkge1xyXG4gICAgICAgICAgICAgICAgY2FjaGUudGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9jYWNoZVRhYmxlLmRlbGV0ZShrZXkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGZzLnJlbW92ZSgoY2FjaGUgYXMgYW55KS5uYW1lLCBlcnIgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcign5riF6Zmk57yT5a2Y5byC5bi477yaJywgZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudFNpemUgLT0gKGNhY2hlIGFzIGFueSkuc2l6ZTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0sIHRoaXMuX3RpbWVvdXQpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLl9jYWNoZVRhYmxlLnNldChrZXksIGNhY2hlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlnKjmiafooYxnZXTkuYvliY3lgZrnmoTkuIDkupvlh4blpIflt6XkvZxcclxuICAgICAqIEBwYXJhbSByZWFkZXIg5omn6KGM5paH5Lu26K+75Y+W5pON5L2c55qE5pa55rOVXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgYXN5bmMgX3ByZXBhcmVHZXQ8VD4oa2V5OiBzdHJpbmcsIHJlYWRlcjogKHBhdGg6IHN0cmluZykgPT4gUHJvbWlzZTxUPik6IFByb21pc2U8VCB8IHVuZGVmaW5lZD4ge1xyXG4gICAgICAgIGNvbnN0IGNhY2hlID0gdGhpcy5fY2FjaGVUYWJsZS5nZXQoa2V5KTtcclxuXHJcbiAgICAgICAgaWYgKGNhY2hlKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLl9yZWZyZXNoVGltZW91dFdoZW5HZXQgJiYgdGhpcy5fdGltZW91dCA+IDApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2NhY2hlVGFibGUuZGVsZXRlKGtleSk7ICAgLy/liLfmlrDnvJPlrZjlnKjliJfooajkuK3nmoTmjpLkvY1cclxuICAgICAgICAgICAgICAgIHRoaXMuX2NhY2hlVGFibGUuc2V0KGtleSwgY2FjaGUpO1xyXG4gICAgICAgICAgICAgICAgKGNhY2hlLnRpbWVyIGFzIE5vZGVKUy5UaW1lcikucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gcmVhZGVyKGNhY2hlLm5hbWUpO1xyXG4gICAgICAgIH0gZWxzZVxyXG4gICAgICAgICAgICByZXR1cm4gY2FjaGU7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDorr7nva7miJbmm7TmlrDnvJPlrZhcclxuICAgICAqIEBwYXJhbSBpc0FwcGVuZCDmmK/lkKbku6Xov73liqDliLDmlofku7bmnKvlsL7nmoTmlrnlvI/lhpnlhaXmlbDmja7vvIzpu5jorqRmYWxzZVxyXG4gICAgICovXHJcbiAgICBzZXQoa2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcgfCBCdWZmZXIgfCBOb2RlSlMuUmVhZGFibGVTdHJlYW0sIGlzQXBwZW5kID0gZmFsc2UpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fcHJlcGFyZVNldChrZXksIHBhdGggPT4ge1xyXG4gICAgICAgICAgICBpZiAoJ3N0cmluZycgPT09IHR5cGVvZiB2YWx1ZSB8fCBCdWZmZXIuaXNCdWZmZXIodmFsdWUpKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZzLnByb21pc2VzLndyaXRlRmlsZShwYXRoLCB2YWx1ZSwgeyBmbGFnOiBpc0FwcGVuZCA/ICdhJyA6ICd3JyB9KTtcclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlLnBpcGUoZnMuY3JlYXRlV3JpdGVTdHJlYW0ocGF0aCwgeyBmbGFnczogaXNBcHBlbmQgPyAnYScgOiAndycgfSkpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5vbignZXJyb3InLCByZWplY3QpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5vbignY2xvc2UnLCByZXNvbHZlKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDpgJrov4fnp7vliqjnjrDlrZjmlofku7bnmoTmlrnlvI/orr7nva7miJbmm7TmlrDnvJPlrZhcclxuICAgICAqIEBwYXJhbSBmcm9tIOimgeenu+WKqOaWh+S7tueahOi3r+W+hFxyXG4gICAgICovXHJcbiAgICBzZXRCeU1vdmUoa2V5OiBzdHJpbmcsIGZyb206IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9wcmVwYXJlU2V0KGtleSwgcGF0aCA9PiBmcy5tb3ZlKGZyb20sIHBhdGgpKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOiOt+WPlue8k+WtmFxyXG4gICAgICovXHJcbiAgICBnZXQoa2V5OiBzdHJpbmcpOiBQcm9taXNlPEJ1ZmZlciB8IHVuZGVmaW5lZD4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9wcmVwYXJlR2V0KGtleSwgZnMucmVhZEZpbGUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Lul5rWB55qE5pa55byP6I635Y+W57yT5a2YXHJcbiAgICAgKi9cclxuICAgIGdldFN0cmVhbShrZXk6IHN0cmluZyk6IFByb21pc2U8Tm9kZUpTLlJlYWRhYmxlU3RyZWFtIHwgdW5kZWZpbmVkPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ByZXBhcmVHZXQoa2V5LCBhc3luYyBwYXRoID0+IGZzLmNyZWF0ZVJlYWRTdHJlYW0ocGF0aCkpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5Yik5pat57yT5a2Y5piv5ZCm5a2Y5ZyoIFxyXG4gICAgICovXHJcbiAgICBoYXMoa2V5OiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fY2FjaGVUYWJsZS5oYXMoa2V5KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOWIoOmZpOe8k+WtmFxyXG4gICAgICovXHJcbiAgICBhc3luYyBkZWxldGUoa2V5OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBjb25zdCBjYWNoZSA9IHRoaXMuX2NhY2hlVGFibGUuZ2V0KGtleSk7XHJcblxyXG4gICAgICAgIGlmIChjYWNoZSkge1xyXG4gICAgICAgICAgICBhd2FpdCBmcy5yZW1vdmUoY2FjaGUubmFtZSk7XHJcbiAgICAgICAgICAgIHRoaXMuX2NhY2hlVGFibGUuZGVsZXRlKGtleSk7XHJcbiAgICAgICAgICAgIGNsZWFyVGltZW91dChjYWNoZS50aW1lciBhcyBhbnkpO1xyXG4gICAgICAgICAgICB0aGlzLl9jdXJyZW50U2l6ZSAtPSBjYWNoZS5zaXplO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOa4heepuue8k+WtmFxyXG4gICAgICovXHJcbiAgICBhc3luYyBlbXB0eSgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiB0aGlzLl9jYWNoZVRhYmxlKSB7XHJcbiAgICAgICAgICAgIGF3YWl0IGZzLnJlbW92ZSh2YWx1ZS5uYW1lKTtcclxuICAgICAgICAgICAgdGhpcy5fY2FjaGVUYWJsZS5kZWxldGUoa2V5KTtcclxuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHZhbHVlLnRpbWVyIGFzIGFueSk7XHJcbiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnRTaXplIC09IHZhbHVlLnNpemU7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6ZSA5q+B57yT5a2YXHJcbiAgICAgKi9cclxuICAgIGFzeW5jIGRlc3Ryb3koKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgYXdhaXQgdGhpcy5lbXB0eSgpO1xyXG4gICAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fY2xlYW5lclRpbWVyKTtcclxuICAgIH1cclxufSJdfQ==
